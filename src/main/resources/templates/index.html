<!DOCTYPE html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>HaiDavai - Călătorii Împărtășite</title>
    <link rel="stylesheet" href="/styles.css?v=1.7">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
</head>
<body>
    <!-- Include Navigation -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="main-content">
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-background"></div>
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">HaiDavai</h1>
                    <p class="hero-subtitle">Conectează-te cu șoferi și călători din întreaga Moldovă</p>
                    
                    <!-- Main Action Buttons -->
                    <div class="main-actions">
                        <div class="action-buttons-container">
                            <div class="action-card driver-card">
                                <div class="action-header">
                                    <h3>Ești șofer?</h3>
                                </div>
                                <a href="#" class="action-btn action-btn-primary" id="create-ride-btn" onclick="handleCreateRideClick(event)">
                                    <div class="btn-icon">
                                        <i class="fas fa-car"></i>
                                    </div>
                                    <div class="btn-content">
                                        <span class="btn-title">Crează o cursă</span>
                                        <span class="btn-subtitle">Împărtășește drumul tău și economisește</span>
                                    </div>
                                </a>
                            </div>
                            
                            <div class="action-card passenger-card">
                                <div class="action-header">
                                    <h3>Ești pasager?</h3>
                                </div>
                                <a href="/rides" class="action-btn action-btn-secondary">
                                    <div class="btn-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <div class="btn-content">
                                        <span class="btn-title">Caută o cursă</span>
                                        <span class="btn-subtitle">Găsește călătoria perfectă pentru tine</span>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent Rides Section -->
        <section class="recent-rides" th:if="${not #lists.isEmpty(recentRides)}">
            <div class="container">
                <div class="recent-rides-header">
                    <h2>Cele mai recente curse</h2>
                    <p>Descoperă ofertele noi de pe platformă</p>
                </div>
                <div class="rides-list">
                    <div th:each="ride : ${recentRides}" class="ride-card" th:data-ride-id="${ride.id}">
                        <div class="ride-header">
                            <div class="ride-route">
                                <div class="route-point">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span th:text="${ride.fromLocation}">De la</span>
                                </div>
                                <div class="route-arrow">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="route-point">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span th:text="${ride.toLocation}">Până la</span>
                                </div>
                            </div>
                            <div class="ride-price">
                                <span class="price" th:text="${ride.price + ' MDL'}">0 MDL</span>
                                <span class="per-seat">per loc</span>
                            </div>
                        </div>
                        <div class="ride-details">
                            <div class="ride-info">
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i>
                                    <span th:text="${#temporals.format(ride.travelDate, 'dd MMM yyyy')}">Data</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-clock"></i>
                                    <span th:text="${#temporals.format(ride.departureTime, 'HH:mm')}">Ora</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-users"></i>
                                    <span th:text="${ride.availableSeats + ' locuri disponibile'}">Locuri</span>
                                </div>
                                <div class="info-item user-profile-link" th:data-user-id="${ride.userId}" style="cursor: pointer;" onclick="navigateToUserProfile(this.getAttribute('data-user-id'))">
                                    <i class="fas fa-user"></i>
                                    <span th:text="${ride.driverName}" class="driver-name">Șofer</span>
                                    <i class="fas fa-external-link-alt profile-link-icon"></i>
                                </div>
                            </div>
                            <div class="ride-actions">
                                <a th:href="@{'/rides'}" class="btn-reserve">
                                    <i class="fas fa-search"></i>
                                    Vezi toate cursele
                                </a>
                            </div>
                        </div>
                        <div th:if="${ride.description}" class="ride-description">
                            <p th:text="${ride.description}">Descriere</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- No Rides Section -->
        <section class="recent-rides" th:if="${#lists.isEmpty(recentRides)}">
            <div class="container">
                <div class="no-rides">
                    <i class="fas fa-search"></i>
                    <h3>Nu sunt curse disponibile momentan</h3>
                    <p>Fii primul care adaugă o cursă!</p>
                    <a href="/add-ride" class="btn-reserve">
                        <i class="fas fa-plus"></i>
                        Adaugă o cursă
                    </a>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features">
            <div class="container">
                <div class="features-header">
                    <h2>De ce HaiDavai?</h2>
                    <p>Descoperă avantajele platformei noastre</p>
                </div>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <h3>Eco-friendly</h3>
                        <p>Reduce amprenta de carbon prin partajarea mașinilor</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <h3>Economie</h3>
                        <p>Împarte costurile de transport cu alți călători</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Comunitate</h3>
                        <p>Cunoaște oameni noi și fă conexii valoroase</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Siguranță</h3>
                        <p>Profiluri verificate și sistem de rating</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Include Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="script.js"></script>
    <script src="/autocomplete.js"></script>
    <script src="navbar.js"></script>
    <script>
        // Force CSS reload to prevent caching issues
        (function() {
            var links = document.getElementsByTagName('link');
            for (var i = 0; i < links.length; i++) {
                if (links[i].rel === 'stylesheet') {
                    var href = links[i].href;
                    var separator = href.indexOf('?') === -1 ? '?' : '&';
                    links[i].href = href + separator + 'v=' + new Date().getTime();
                }
            }
        })();

        // Funcție pentru gestionarea click-ului pe butonul "Crează o cursă"
        function handleCreateRideClick(event) {
            event.preventDefault();
            
            // Verificăm dacă utilizatorul este logat
            fetch('/api/auth/user')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return null;
                    }
                })
                .then(user => {
                    if (user) {
                        // Utilizatorul este logat, redirecționăm la pagina de adăugare cursă
                        window.location.href = '/add-ride';
                    } else {
                        // Utilizatorul nu este logat, redirecționăm la pagina de logare
                        // Salvăm URL-ul curent pentru a reveni după logare
                        sessionStorage.setItem('redirectAfterLogin', '/add-ride');
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('Error checking auth status:', error);
                    // În caz de eroare, redirecționăm la logare
                    sessionStorage.setItem('redirectAfterLogin', '/add-ride');
                    window.location.href = '/login';
                });
        }

        // Funcție pentru navigarea către profilul utilizatorului
        function navigateToUserProfile(userId) {
            if (userId) {
                window.location.href = `/profile/${userId}`;
            } else {
                console.error('User ID is missing');
            }
        }
    </script>
</body>
</html>
